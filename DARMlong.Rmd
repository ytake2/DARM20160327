---
title: "1つ上の潜在成長曲線モデル"
author: 竹林 由武(統数研)
date: 2016-3-27 @Hirosima.Univ
output:
  revealjs::revealjs_presentation:
    pandoc_args: ["--slide-level", "2"]
    theme: white
    hilight: default
    center: true
    transition: fade
    incremental: true
    fig_width: 7
    fig_height: 4
    reveal_options:
      slideNumber: true
      previewLinks: true
---

```{r, results='hide',echo=F,message=F,warning=F}
library(knitr)
opts_chunk$set(warning=F, message=F,echo=F)
```

# Topics  

## 　 

### 1. 非線形の成長曲線モデル 
  - piecewise models
  - polynominal model
  - latetn basis model  
  
###　  
  
      
### 2.多変量の成長曲線モデル
  - autoregressive latent trajectory Model
  - latent change score model


# 非線形モデルのモチベ

## ある時点から傾きが異なる

```{r, out.width = 500, fig.retina = NULL}
knitr::include_graphics("img/piecewise1.jpg")
```
  
### piecewise model  

## ２次(以上)の曲線で

```{r, out.width = 500, fig.retina = NULL}
knitr::include_graphics("img/quad.jpeg")
```
  
### polynominal model  

## データドリブンに

```{r, out.width = 500, fig.retina = NULL}
knitr::include_graphics("img/latent.jpeg")
```
  
### latent basis model  

# サンプルデータ

## BMIの経時データ
- 6時点のBody Mass Index (BMI)

```{r,echo=F, results="asis"}
data<-read.csv("data/bmi.csv",header=T)
library(ggplot2)
library(plyr)
M<-sapply(data,mean)[3:8]
SD<-sapply(data,sd)[3:8]
M<-data.frame(mean=M,sd=SD, time=0:5)
library(xtable)
M<-round(M,digits=2)
print(xtable(t(M[,1:2])), comment=F, type="html")
```

```{r}
ggplot(M, aes(x=time,y=mean, group=1))+ 
              geom_line()+ylim(27,28)+theme_bw()
```

## 普通にLCM

```{r, echo=T}
model0<-'
#切片因子の設定
i =~ 1*bmi1 + 1*bmi2 + 1*bmi3 + 
     1*bmi4 + 1*bmi5 + 1*bmi6
     
#傾き因子の設定
s1 =~ 0*bmi1 + 1*bmi2 + 2*bmi3 +
      3*bmi4 + 4*bmi5 + 5*bmi6

#切片と傾きの分散
i ~~ i ; s1 ~~ s1 ;
#因子間相関
i ~~ s1
#因子平均
i ~ 1 ; s1 ~ 1 
#誤差分散
bmi1 ~ 0; bmi2 ~ 0; bmi3 ~ 0
bmi4 ~ 0; bmi5 ~ 0; bmi6 ~ 0
'
```


## LCMの推定結果

```{r, echo=T, resuts='asis'}
# 成長曲線モデルの推定
library(lavaan)
model0.fit<-growth(model0,data=data)
```

```{r, results='asis'}
#適合度の抽出
fit0.m<-round(fitMeasures(model0.fit)
            [c("chisq","df","pvalue",
               "cfi","srmr","rmsea")],digits=2)
fit0.m<-t(as.data.frame(fit0.m))
print(xtable(fit0.m),comment=F,type="html")
```


## パラメータの推定値
```{r}
library(DT)
fit0.params<-as.data.frame(parameterEstimates(model0.fit))
fit0.params[,4:ncol(fit0.params)]<-round(fit0.params[,4:ncol(fit0.params)],digits=3)
fit0.is<-fit0.params[13:17,]
fit0.is<-fit0.is[c(4,5,1,2,3),]
fit0.is[,2]<-c("平均","　","分散","　", "因子間相関")
fit0.is<-fit0.is[,-3]
#fit0.is<-fit[]
datatable(fit0.is)
```

-


# Piecewise Model

##　コード全体

```{r}
model1 <-'

#切片因子の設定
i =~ 1*bmi1 + 1*bmi2 + 1*bmi3 + 
     1*bmi4 + 1*bmi5 + 1*bmi6
     
#傾き因子の設定
s1 =~ 0*bmi1 + 1*bmi2 + 2*bmi3 +
      3*bmi4 + 3*bmi5 + 3*bmi6

s2 =~ 0*bmi1 + 0*bmi2 + 0*bmi3 + 
      0*bmi4 + 1*bmi5 + 2*bmi6

#切片と傾きの分散
i ~~ i ; s1 ~~ s1 ; s2 ~~ s2

#因子間相関
i ~~ s1 + s2 ; s1 ~~ s2

#因子平均
i ~ 1 ; s1 ~ 1 ; s2 ~ 1

#誤差分散
bmi1 ~ 0; bmi2 ~ 0; bmi3 ~ 0
bmi4 ~ 0; bmi5 ~ 0; bmi6 ~ 0
'
```

## 切片因子の設定  
- 因子負荷を1に固定 

```
#lavaan code
i =~ 1*t1+1*t2+1*t3+1*t4+1*t5
```
```{r, echo=F}
source("diag.R")
library(DiagrammeR)
grViz(int)
```

## 前半の傾きの設定  
前半の傾き(s1)の因子負荷を  
区分時点以降同値に固定  

```
#lavaan model code
i=~0*t1+1*t2+2*t3+1*t3+1*t3
```
```{r, fig.align='right', echo=F}
grViz(s1)
```

## 後半の傾きの設定
後半の傾き(s1)の因子負荷を  
区分時点まで0に固定  
```
#lavaan model code
i=~0*t1+0*t2+0*t3+1*t4+2*t5
```
```{r, fig.align='right', echo=F}
grViz(s2)
```


## その他の設定
- 切片と傾きの分散を自由推定
- 因子間相関を自由推定
- 因子平均を自由推定
- 誤差分散を0に固定  

```
#切片と傾きの分散
i ~~ i ; s1 ~~ s1 ; s2 ~~ s2
#因子間相関
i ~~ s1 + s2 ; s1 ~~ s2
#因子平均
i ~ 1 ; s1 ~ 1 ; s2 ~ 1
#誤差分散
bmi1 ~ 0; bmi2 ~ 0; bmi3 ~ 0
bmi4 ~ 0; bmi5 ~ 0; bmi6 ~ 0
'
```


## 推定の実行  
- モデル

```
library(lavaan)
model1.fit<-lavaan::growth(model1, data)
```
```{r}
library(lavaan)
model1.fit<-lavaan::growth(model1, data)
```

- 適合度
```
fit1.m<-round(fitMeasures(model1)[c("chisq","df","pvalue",
                                  "cfi","srmr","rmsea")],digits=2)
fit1.m<-t(as.data.frame(fit1))
print(xtable(fit1.m),comment=F,type="html")
```
```{r, results='asis'}
fit1.m<-round(fitMeasures(model1.fit)
            [c("chisq","df","pvalue",
               "cfi","srmr","rmsea")],digits=2)
fit1.m<-t(as.data.frame(fit1.m))
print(xtable(fit1.m),comment=F,type="html")
```


# polynomial models

## 二次以上の曲線モデル  
- quadratic curveなど
- 時間変数のコーディング要検討

```{r, out.width = 400, fig.retina = NULL}
knitr::include_graphics("img/quad.jpeg")
```

## こんなモデル

# latent basis model

## データドリブンに遷移パターンを推定
- 傾きの因子負荷を自由推定する

```{r, out.width = 400, fig.retina = NULL}
knitr::include_graphics("img/latent.jpeg")
```

## こんなモデル




