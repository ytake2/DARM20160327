---
title: "1つ上の潜在成長曲線モデル"
author: 竹林 由武(統数研)
date: 2016-3-27 @Hirosima.Univ
output:
  revealjs::revealjs_presentation:
    pandoc_args: ["--slide-level", "2"]
    theme: white
    hilight: default
    center: true
    transition: fade
    incremental: true
    fig_width: 7
    fig_height: 4
    reveal_options:
      slideNumber: true
      previewLinks: true
---

```{r, results='hide',echo=F,message=F,warning=F}
library(knitr)
opts_chunk$set(warning=F, message=F,echo=F)
```

# Topics  

## 　 

### 1. 非線形の成長曲線モデル 
  - polynominal model
  - latetn basis model 
  - piecewise models
  
###　  
  
      
### 2.多変量の成長曲線モデル
  - autoregressive latent trajectory Model
  - latent change score model


# 非線形モデルのモチベ

## ２次(以上)の曲線で

```{r, out.width = 500, fig.retina = NULL}
knitr::include_graphics("img/quad.jpeg")
```
  
### polynominal model  

## データドリブンに

```{r, out.width = 500, fig.retina = NULL}
knitr::include_graphics("img/latent.jpeg")
```
  
### latent basis model  

## ある時点から傾きが異なる

```{r, out.width = 500, fig.retina = NULL}
knitr::include_graphics("img/piecewise1.jpg")
```
  
### piecewise model  

# サンプルデータ

## BMIの経時データ
```{r,echo=F, results="asis"}
data<-read.csv("data/Garland.csv",header=T)
data<-data[,2:7]

library(ggplot2)
library(plyr)
library(shiny)
library(shinyapps)

M<-as.data.frame(t(sapply(data,each(mean,sd))))
M<-round(M,digits=2)
M$time<-0:5

library(DT)
M2<-t(M)
datatable(M2, options = list(dom = 't'))
```


```{r, fig.width=5, fig.height=2}
ggplot(M, aes(x=time,y=mean, group=1))+ 
              geom_line(col="blue", size=3)+
              ylim(3,4)+
              #geom_line(aes(y=mean.Y,group=1),size=3,col="red")+
              theme_bw()
```

Newsom, J. T. (2015). Longitudinal Structural Equation Modeling: A Comprehensive Introduction. Routledge.  
http://www.longitudinalsem.com/health.dat  


# Rで潜在成長曲線モデル

## lavaanでまじめに書く
```
level =~ 1* bmi1 +1* bmi2 +1* bmi3 +
         1* bmi4 +1* bmi5 +1* bmi6 
slope =~ 0 * bmi1 + 1 * bmi2 + 2 * bmi3 + 
         3 * bmi4 + 4 * bmi5 + 5 * bmi6 
bmi1 ~~(vare)* bmi1 
bmi2 ~~(vare)* bmi2 
bmi3 ~~(vare)* bmi3 
bmi4 ~~(vare)* bmi4 
bmi5 ~~(vare)* bmi5 
bmi6 ~~(vare)* bmi6 
```
結構めんどい...

## 救世主登場
### RAMpathパッケージ  
- 潜在成長曲線系のlavaanコードを自動生成して実行してくれる関数が充実    
    - 成長曲線モデル: ramLCM    
    - 潜在差得点モデル:ramLCS    
    - 2変量の潜在差得点モデル: ramBLCS    
     
- lavaanのモデルを吐き出せるので、RAMpathで実行した後lavaanで微調整という流れで効率よくモデリング

## ramLCM
- 切片のみのモデル (model='no')
    
- 線形モデル (model='linear')
    
- 二次曲線モデル (model='quadratic')
    
- latent basisモデル (model = 'latent')

## 一行で簡潔に推定
### 一気にどん
```{r, echo=T, results='hide'}
library(RAMpath)
fit.all<-ramLCM(data=data,outcome=1:6, model='all')
```

### 個別にどん
```{r, echo=T, results='hide'}
fit.no<-ramLCM(data=data,outcome=1:6, model='no')
fit.linear<-ramLCM(data=data,outcome=1:6, model='linear')
fit.quadratic<-ramLCM(data=data,outcome=1:6, model='quadratic')
fit.latent<-ramLCM(data=data,outcome=1:6, model='latent')
```

## 切片のみモデル
 lavannコード
```{r, echo=T}
cat(fit.all$model$no)
```

## 線形モデル
 lavannコード
```{r, echo=T}
cat(fit.all$model$linear)
```

## 二次曲線モデル
 lavannコード
```{r, echo=T}
cat(fit.all$model$quadratic)
```

## latent basisモデル
 lavannコード
```{r, echo=T}
cat(fit.all$model$latent)
```

## 適合度

```{r, echo=T}
fits<-round(fit.all$fit[
            c("chisq","df","pvalue","cfi",
              "srmr","rmsea","aic","bic"),],digits=2)
datatable(fits,option=list(dom='t'))
```


## おまけ (ポチッってデータ取得)

```{r, echo=T}
datatable(fits, extensions = 'Buttons', 
          options = list(dom = 'Bfrtip',
          buttons = c('copy', 'csv', 'excel', 'pdf', 'print')))
```


## 推定結果の出力

```{r}
datatable(parameterEstimates(fit.all$lavaan$quadratic),
          options=list(dom="t"))
```

## 推定平均値の遷移プロット

```{r, echo=T}
source("script/plot.growth.R")
g<-plot.growth(fit.all, type="quad")
g+ylim(3,4)+theme_bw()
```







